(function(a){var c=(a.browser.msie?"paste":"input")+".mask",b=window.orientation!=undefined;a.mask={definitions:{"9":"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"}};a.fn.extend({caret:function(a,b){if(this.length==0)return;if(typeof a=="number"){b=typeof b=="number"?b:a;return this.each(function(){if(this.setSelectionRange){this.focus();this.setSelectionRange(a,b)}else if(this.createTextRange){var c=this.createTextRange();c.collapse(true);c.moveEnd("character",b);c.moveStart("character",a);c.select()}})}else{if(this[0].setSelectionRange){a=this[0].selectionStart;b=this[0].selectionEnd}else if(document.selection&&document.selection.createRange){var c=document.selection.createRange();a=0-c.duplicate().moveStart("character",-1e5);b=a+c.text.length}return{begin:a,end:b}}},unmask:function(){return this.trigger("unmask")},mask:function(g,f){if(!g&&this.length>0){var k=a(this[0]),d=k.data("tests");return a.map(k.data("buffer"),function(a,b){return d[b]?a:null}).join("")}f=a.extend({placeholder:"_",completed:null},f);var j=a.mask.definitions,d=[],h=g.length,i=null,e=g.length;a.each(g.split(""),function(b,a){if(a=="?"){e--;h=b}else if(j[a]){d.push(new RegExp(j[a]));if(i==null)i=d.length-1}else d.push(null)});return this.each(function(){var k=a(this),l=a.map(g.split(""),function(a){if(a!="?")return j[a]?f.placeholder:a}),n=false,q=k.val();k.data("buffer",l).data("tests",d);function p(a){while(++a<=e&&!d[a]);return a}function u(b){while(!d[b]&&--b>=0);for(var a=b;a<e;a++)if(d[a]){l[a]=f.placeholder;var c=p(a);if(c<e&&d[a].test(l[c]))l[a]=l[c];else break}o();k.caret(Math.max(i,b))}function v(h){for(var a=h,g=f.placeholder;a<e;a++)if(d[a]){var b=p(a),c=l[a];l[a]=g;if(b<e&&d[b].test(c))g=c;else break}}function s(e){var d=a(this).caret(),c=e.keyCode;n=c<16||c>16&&c<32||c>32&&c<41;d.begin-d.end!=0&&(!n||c==8||c==46)&&r(d.begin,d.end);if(c==8||c==46||b&&c==127){u(d.begin+(c==46?0:-1));return false}else if(c==27){k.val(q);k.caret(0,m());return false}}function t(b){if(n){n=false;return b.keyCode==8?false:null}b=b||window.event;var g=b.charCode||b.keyCode||b.which,j=a(this).caret();if(b.ctrlKey||b.altKey||b.metaKey)return true;else if(g>=32&&g<=125||g>186){var c=p(j.begin-1);if(c<e){var h=String.fromCharCode(g);if(d[c].test(h)){v(c);l[c]=h;o();var i=p(c);a(this).caret(i);f.completed&&i==e&&f.completed.call(k)}}}return false}function r(b,c){for(var a=b;a<c&&a<e;a++)if(d[a])l[a]=f.placeholder}function o(){return k.val(l.join("")).val()}function m(j){for(var g=k.val(),b=-1,a=0,c=0;a<e;a++)if(d[a]){l[a]=f.placeholder;while(c++<g.length){var m=g.charAt(c-1);if(d[a].test(m)){l[a]=m;b=a;break}}if(c>g.length)break}else if(l[a]==g[c]&&a!=h){c++;b=a}if(!j&&b+1<h){k.val("");r(0,e)}else if(j||b+1>=h){o();!j&&k.val(k.val().substring(0,b+1))}return h?a:i}!k.attr("readonly")&&k.one("unmask",function(){k.unbind(".mask").removeData("buffer").removeData("tests")}).bind("focus.mask",function(){q=k.val();var a=m();o();setTimeout(function(){if(a==g.length)k.caret(0,a);else k.caret(a)},0)}).bind("blur.mask",function(){m();k.val()!=q&&k.change()}).bind("keydown.mask",s).bind("keypress.mask",t).bind(c,function(){setTimeout(function(){k.caret(m(true))},0)});m()})}})})(jQuery)